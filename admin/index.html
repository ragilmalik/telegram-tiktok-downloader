<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader Analytics - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #151515;
            --bg-card: #1a1a1a;
            --bg-hover: #252525;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --accent-info: #3b82f6;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --border-color: #2a2a2a;
            --shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Layout */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 15px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s ease;
        }

        .stat-card:hover::before {
            width: 100%;
            opacity: 0.05;
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-subtext {
            color: var(--text-muted);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trend-up {
            color: var(--accent-success);
        }

        .trend-down {
            color: var(--accent-danger);
        }

        /* Controls */
        .controls {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input,
        .input-group select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--accent-success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--accent-danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--accent-warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(102, 126, 234, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table th {
            text-align: left;
            padding: 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .table th:hover {
            color: var(--accent-primary);
        }

        .table th.sortable::after {
            content: '‚áÖ';
            margin-left: 8px;
            opacity: 0.3;
        }

        .table th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
            color: var(--accent-primary);
        }

        .table th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
            color: var(--accent-primary);
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: var(--bg-hover);
        }

        .table tbody tr.selected {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid var(--accent-primary);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-info);
        }

        /* Platform List */
        .platform-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .platform-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .platform-item:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .platform-name {
            font-weight: 600;
            font-size: 15px;
        }

        .platform-count {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        /* Charts */
        .chart-container {
            margin-top: 24px;
        }

        .day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .day-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .day-item:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .day-item .date {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .day-item .count {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .day-item .success-rate {
            font-size: 12px;
            color: var(--accent-success);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Checkbox */
        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: toastSlideIn 0.3s ease;
            z-index: 2000;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-left: 4px solid var(--accent-success);
        }

        .toast.error {
            border-left: 4px solid var(--accent-danger);
        }

        /* Pagination */
        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-top: 24px;
        }

        .pagination button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 24px;
            }

            .header h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>
                    üìä Video Downloader Analytics
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>LIVE</span>
                    </div>
                </h1>
                <p>Real-time monitoring and comprehensive analytics dashboard</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="card loading">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary);">Loading analytics data...</p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Downloads</h3>
                    <div class="stat-value" id="totalDownloads">-</div>
                    <div class="stat-subtext">
                        <span>All time requests</span>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Success Rate</h3>
                    <div class="stat-value" id="successRate">-<span style="font-size: 20px;">%</span></div>
                    <div class="stat-subtext">
                        <span id="successfulDownloads">-</span> successful
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Unique Users</h3>
                    <div class="stat-value" id="uniqueUsers">-</div>
                    <div class="stat-subtext">
                        <span>Total users served</span>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Cache Hit Rate</h3>
                    <div class="stat-value" id="cacheHitRate">-<span style="font-size: 20px;">%</span></div>
                    <div class="stat-subtext">
                        <span>Bandwidth saved</span>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Avg Download Time</h3>
                    <div class="stat-value" id="avgDownloadTime">-<span style="font-size: 20px;">s</span></div>
                    <div class="stat-subtext">
                        <span>Processing time</span>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Total Data</h3>
                    <div class="stat-value" id="totalFileSize">-</div>
                    <div class="stat-subtext">
                        <span>Downloaded bandwidth</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="controls-grid">
                    <div class="input-group">
                        <label>üîç Search</label>
                        <input type="text" id="searchInput" placeholder="Search by username, URL, platform...">
                    </div>

                    <div class="input-group">
                        <label>üìÖ Date From</label>
                        <input type="date" id="dateFrom">
                    </div>

                    <div class="input-group">
                        <label>üìÖ Date To</label>
                        <input type="date" id="dateTo">
                    </div>

                    <div class="input-group">
                        <label>üåê Platform</label>
                        <select id="platformFilter">
                            <option value="">All Platforms</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>‚úÖ Status</label>
                        <select id="statusFilter">
                            <option value="">All Status</option>
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                            <option value="cached">From Cache</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>üìä Show</label>
                        <select id="limitSelect">
                            <option value="50">50 entries</option>
                            <option value="100">100 entries</option>
                            <option value="200">200 entries</option>
                            <option value="500">500 entries</option>
                            <option value="all">All entries</option>
                        </select>
                    </div>
                </div>

                <div class="button-group" style="margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="applyFilters()">üîÑ Apply Filters</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">‚úñÔ∏è Reset</button>
                    <button class="btn btn-success" onclick="exportData('json')">üìÑ Export JSON</button>
                    <button class="btn btn-success" onclick="exportData('csv')">üìä Export CSV</button>
                    <button class="btn btn-danger" onclick="deleteSelected()" id="deleteBtn" style="display: none;">üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)</button>
                    <button class="btn btn-warning" onclick="refreshData()">üîÑ Refresh</button>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Recent Downloads Table -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h2>üïí Recent Downloads</h2>
                        <div class="button-group">
                            <button class="btn btn-secondary" onclick="selectAll()">‚òëÔ∏è Select All</button>
                            <button class="btn btn-secondary" onclick="deselectAll()">‚¨ú Deselect All</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" class="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                                    <th class="sortable" onclick="sortTable('timestamp')">Date</th>
                                    <th class="sortable" onclick="sortTable('username')">User</th>
                                    <th class="sortable" onclick="sortTable('platform')">Platform</th>
                                    <th class="sortable" onclick="sortTable('success')">Status</th>
                                    <th class="sortable" onclick="sortTable('file_size')">Size</th>
                                    <th class="sortable" onclick="sortTable('download_time_ms')">Time</th>
                                    <th>URL</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="downloadsTable">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        <div class="empty-state-icon">üìä</div>
                                        <div>Loading download history...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination" id="pagination"></div>
                </div>

                <!-- Platform Breakdown -->
                <div class="card">
                    <div class="card-header">
                        <h2>üåê Platform Breakdown</h2>
                    </div>
                    <div class="platform-list" id="platformList"></div>
                </div>

                <!-- Last 7 Days Activity -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìà Last 7 Days</h2>
                    </div>
                    <div class="day-stats" id="dayStats"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Confirm Deletion</h3>
                <p style="color: var(--text-secondary); margin-top: 8px;">This action cannot be undone.</p>
            </div>
            <p>Are you sure you want to delete <strong id="deleteCount">0</strong> selected record(s)?</p>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let selectedRows = new Set();
        let currentSort = { column: 'timestamp', direction: 'desc' };
        let currentPage = 1;
        let itemsPerPage = 50;

        // Load stats and data
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) throw new Error('Failed to fetch stats');

                const data = await response.json();

                // Update stats
                document.getElementById('totalDownloads').textContent = data.totalDownloads.toLocaleString();
                document.getElementById('successfulDownloads').textContent = data.successfulDownloads.toLocaleString();

                const successRate = data.totalDownloads > 0
                    ? ((data.successfulDownloads / data.totalDownloads) * 100).toFixed(1)
                    : 0;
                document.getElementById('successRate').innerHTML = successRate + '<span style="font-size: 20px;">%</span>';

                document.getElementById('uniqueUsers').textContent = data.uniqueUsers.toLocaleString();
                document.getElementById('cacheHitRate').innerHTML = data.cacheHitRate + '<span style="font-size: 20px;">%</span>';

                const avgTime = (data.avgDownloadTime / 1000).toFixed(1);
                document.getElementById('avgDownloadTime').innerHTML = avgTime + '<span style="font-size: 20px;">s</span>';

                const totalSize = data.totalFileSize || 0;
                const sizeInGB = (totalSize / (1024 * 1024 * 1024)).toFixed(2);
                const sizeInMB = (totalSize / (1024 * 1024)).toFixed(1);
                document.getElementById('totalFileSize').textContent =
                    totalSize > 1024 * 1024 * 1024 ? sizeInGB + ' GB' : sizeInMB + ' MB';

                // Update platform breakdown
                const platformList = document.getElementById('platformList');
                const platformFilter = document.getElementById('platformFilter');

                if (data.platformBreakdown && data.platformBreakdown.length > 0) {
                    platformList.innerHTML = data.platformBreakdown
                        .map(p => `
                            <div class="platform-item">
                                <span class="platform-name">${p.platform}</span>
                                <span class="platform-count">${p.count.toLocaleString()}</span>
                            </div>
                        `)
                        .join('');

                    // Update platform filter
                    const currentValue = platformFilter.value;
                    platformFilter.innerHTML = '<option value="">All Platforms</option>' +
                        data.platformBreakdown
                            .map(p => `<option value="${p.platform}">${p.platform} (${p.count})</option>`)
                            .join('');
                    platformFilter.value = currentValue;
                } else {
                    platformList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üåê</div><div>No platform data yet</div></div>';
                }

                // Update day stats
                const dayStats = document.getElementById('dayStats');
                if (data.downloadsByDay && data.downloadsByDay.length > 0) {
                    dayStats.innerHTML = data.downloadsByDay
                        .slice(0, 7)
                        .map(day => {
                            const successRate = day.count > 0
                                ? ((day.successful / day.count) * 100).toFixed(0)
                                : 0;
                            const date = new Date(day.date);
                            return `
                                <div class="day-item">
                                    <div class="date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                    <div class="count">${day.count}</div>
                                    <div class="success-rate">${successRate}% ‚úì</div>
                                </div>
                            `;
                        })
                        .join('');
                } else {
                    dayStats.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div><div>No recent activity</div></div>';
                }

                // Store data for filtering
                allData = data.recentDownloads || [];
                applyFilters();

                // Show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: var(--accent-danger); text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                        <h3>Failed to load analytics</h3>
                        <p style="color: var(--text-secondary); margin-top: 8px;">Please make sure the bot is running</p>
                        <button class="btn" onclick="location.reload()" style="margin-top: 16px;">üîÑ Retry</button>
                    </div>
                `;
            }
        }

        // Apply filters
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const platform = document.getElementById('platformFilter').value;
            const status = document.getElementById('statusFilter').value;
            const limit = document.getElementById('limitSelect').value;

            filteredData = allData.filter(item => {
                // Search filter
                if (search) {
                    const searchText = `${item.username} ${item.first_name} ${item.last_name} ${item.url} ${item.platform}`.toLowerCase();
                    if (!searchText.includes(search)) return false;
                }

                // Date filter
                if (dateFrom) {
                    const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                    if (itemDate < dateFrom) return false;
                }
                if (dateTo) {
                    const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                    if (itemDate > dateTo) return false;
                }

                // Platform filter
                if (platform && item.platform !== platform) return false;

                // Status filter
                if (status === 'success' && !item.success) return false;
                if (status === 'failed' && item.success) return false;
                if (status === 'cached' && !item.from_cache) return false;

                return true;
            });

            // Apply limit
            if (limit !== 'all') {
                itemsPerPage = parseInt(limit);
            }

            // Sort
            sortData();

            // Reset to first page
            currentPage = 1;
            renderTable();
            updatePagination();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('platformFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('limitSelect').value = '50';
            applyFilters();
            showToast('Filters reset', 'success');
        }

        // Sort table
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }

            // Update UI
            document.querySelectorAll('.table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const th = event.target;
            th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');

            sortData();
            renderTable();
        }

        function sortData() {
            filteredData.sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                if (currentSort.column === 'timestamp') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        // Render table
        function renderTable() {
            const table = document.getElementById('downloadsTable');

            if (filteredData.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <div>No downloads found matching your filters</div>
                        </td>
                    </tr>
                `;
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = document.getElementById('limitSelect').value === 'all'
                ? filteredData.length
                : start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            table.innerHTML = pageData.map(item => {
                const date = new Date(item.timestamp).toLocaleString();
                const username = item.username || item.first_name || `User ${item.user_id}`;
                const status = item.success ? 'success' : 'error';
                const statusText = item.success
                    ? (item.from_cache ? 'üì¶ Cached' : '‚úÖ Success')
                    : '‚ùå Failed';
                const size = item.file_size
                    ? (item.file_size / (1024 * 1024)).toFixed(2) + ' MB'
                    : '-';
                const time = item.download_time_ms
                    ? (item.download_time_ms / 1000).toFixed(1) + 's'
                    : '-';
                const urlPreview = item.url.length > 40
                    ? item.url.substring(0, 40) + '...'
                    : item.url;
                const isSelected = selectedRows.has(item.id);

                return `
                    <tr class="${isSelected ? 'selected' : ''}" data-id="${item.id}">
                        <td><input type="checkbox" class="checkbox row-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRow(${item.id})"></td>
                        <td style="font-size: 12px; color: var(--text-secondary);">${date}</td>
                        <td>${username}</td>
                        <td><span class="badge badge-info">${item.platform}</span></td>
                        <td><span class="badge badge-${status}">${statusText}</span></td>
                        <td>${size}</td>
                        <td>${time}</td>
                        <td style="font-size: 12px; color: var(--text-secondary);" title="${item.url}">${urlPreview}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteSingle(${item.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateSelectedCount();
        }

        // Pagination
        function updatePagination() {
            if (document.getElementById('limitSelect').value === 'all') {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');

            let html = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(1)">‚èÆÔ∏è First</button>
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">‚óÄÔ∏è Prev</button>
            `;

            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            html += `
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Next ‚ñ∂Ô∏è</button>
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${totalPages})">Last ‚è≠Ô∏è</button>
            `;

            pagination.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
            updatePagination();
        }

        // Selection
        function toggleRow(id) {
            if (selectedRows.has(id)) {
                selectedRows.delete(id);
            } else {
                selectedRows.add(id);
            }
            renderTable();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox.checked) {
                selectAll();
            } else {
                deselectAll();
            }
        }

        function selectAll() {
            filteredData.forEach(item => selectedRows.add(item.id));
            document.getElementById('selectAllCheckbox').checked = true;
            renderTable();
        }

        function deselectAll() {
            selectedRows.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            renderTable();
        }

        function updateSelectedCount() {
            const count = selectedRows.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('deleteBtn').style.display = count > 0 ? 'inline-flex' : 'none';
        }

        // Delete
        function deleteSingle(id) {
            selectedRows.clear();
            selectedRows.add(id);
            deleteSelected();
        }

        function deleteSelected() {
            if (selectedRows.size === 0) return;
            document.getElementById('deleteCount').textContent = selectedRows.size;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            const ids = Array.from(selectedRows);

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });

                if (!response.ok) throw new Error('Delete failed');

                showToast(`Deleted ${ids.length} record(s)`, 'success');
                selectedRows.clear();
                closeDeleteModal();
                refreshData();
            } catch (error) {
                showToast('Failed to delete records', 'error');
            }
        }

        // Export
        function exportData(format) {
            const url = `/api/export/${format}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast(`Exported as ${format.toUpperCase()}`, 'success');
        }

        // Refresh
        function refreshData() {
            loadStats();
            showToast('Data refreshed', 'success');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Real-time search
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(applyFilters, 300);
        });

        // Initialize
        loadStats();

        // Auto-refresh every 30 seconds
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
